<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Platform - History</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles2.css">
    <style>
        .page-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .page-navigation {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <!-- Logo and Back Buttons -->
            <div style="display: flex; align-items: center; gap: 1rem;">
                <a href="dashboard.html" class="btn btn-outline-secondary btn-sm" title="Back to Overdue">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <a href="index.html" class="btn btn-outline-secondary btn-sm" title="Back to Main Menu">
                    <i class="fas fa-home"></i>
                </a>
                <div class="nav-brand">
                    <div class="nav-logo">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <span>Analytics Platform</span>
                </div>
            </div>

            <!-- Language Selector -->
            <div>
                <select id="languageSelect" class="form-control" style="width: auto; min-width: 120px;">
                    <option value="en" selected>üá∫üá∏ English</option>
                    <option value="pl">üáµüá± Polski</option>
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                </select>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="table-container">
        <!-- Hero Section -->
        <div class="hero-gradient">
            <div class="container">
                <h1 class="fade-in">Analysis History</h1>
                <p class="text-secondary fade-in" style="max-width: 600px;">
                    View and analyze historical data trends
                </p>
                <div class="fade-in" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; padding: 0.5rem 0.75rem; margin-top: 0.5rem; display: inline-block;">
                    <i class="fas fa-info-circle" style="color: var(--info); margin-right: 0.25rem;"></i>
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">All times are displayed in UTC timezone</span>
                </div>
            </div>
        </div>

        <!-- History Content -->
        <div class="container" style="padding: 2rem 0;">
            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-item fade-in">
                    <div style="font-size: 0.875rem; color: var(--text-tertiary);">Total Analyses</div>
                    <div class="stat-value" id="totalAnalyses">0</div>
                    <div style="font-size: 0.75rem; color: var(--success);">+12%</div>
                </div>

                <div class="stat-item fade-in">
                    <div style="font-size: 0.875rem; color: var(--text-tertiary);">Avg Packages</div>
                    <div class="stat-value" id="avgPackages">0</div>
                    <div style="font-size: 0.75rem; color: var(--success);">+5%</div>
                </div>

                <div class="stat-item fade-in">
                    <div style="font-size: 0.875rem; color: var(--text-tertiary);">Last Analysis</div>
                    <div class="stat-value" id="lastAnalysis" style="font-size: 1.25rem;">-</div>
                    <div style="font-size: 0.75rem; color: var(--text-tertiary);">recent</div>
                </div>

                <div class="stat-item fade-in">
                    <div style="font-size: 0.875rem; color: var(--text-tertiary);">Trend</div>
                    <div class="stat-value" id="trend" style="font-size: 1.25rem;">-</div>
                    <div style="font-size: 0.75rem; color: var(--success);">positive</div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="card mb-4">
                <div class="chart-controls">
                    <h2 style="display: flex; align-items: center; gap: 1rem; margin: 0;">
                        <i class="fas fa-chart-area" style="color: var(--primary);"></i>
                        Analysis History
                    </h2>

                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="chartRange" class="form-control" style="width: auto;">
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="all">All time</option>
                        </select>

                        <button class="btn btn-warning" onclick="refreshChart()" title="Refresh chart">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Chart
                        </button>

                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="exportSimpleHistory()">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>

                        <button class="btn btn-secondary" onclick="exportAsCSV()">
                            <i class="fas fa-file-csv mr-2"></i>Export CSV
                        </button>
                    </div>
                </div>

                <div class="chart-container" style="height: 400px;">
                    <canvas id="historyChart"></canvas>
                </div>
            </div>

            <!-- History Table -->
            <div class="card">
                <div class="chart-controls">
                    <h2 style="display: flex; align-items: center; gap: 1rem; margin: 0;">
                        <i class="fas fa-table" style="color: var(--primary);"></i>
                        Analysis History
                    </h2>

                    <div class="table-controls">
                        <!-- Search and sort -->
                        <div class="search-container" style="position: relative;">
                            <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary);"></i>
                            <input type="text" id="tableSearch" class="form-control"
                                   style="padding-left: 40px;"
                                   placeholder="Search"
                                   oninput="filterHistoryTable()">
                        </div>

                        <select id="tableSort" class="form-control" style="width: auto;">
                            <option value="newest">Newest first</option>
                            <option value="oldest">Oldest first</option>
                        </select>

                        <!-- Bulk delete button -->
                        <button id="bulkDeleteBtn" class="btn btn-danger" onclick="bulkDeleteSelected()" disabled>
                            <i class="fas fa-trash mr-2"></i>
                            <span id="selectedCount">0</span> Delete
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingHistory" class="hidden" style="text-align: center; padding: 2rem;">
                    <div style="display: inline-flex; align-items: center; gap: 0.75rem;">
                        <div class="loading-spinner"></div>
                        <span>Loading</span>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyHistory" class="hidden" style="text-align: center; padding: 3rem 1rem;">
                    <div style="font-size: 3rem; color: var(--text-tertiary); margin-bottom: 1rem;">
                        <i class="fas fa-history"></i>
                    </div>
                    <h3 style="margin-bottom: 0.5rem;">No data</h3>
                    <p class="text-tertiary">No analysis history available</p>
                </div>

                <!-- Table -->
                <div id="historyTableContainer" class="hidden">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
                                    </th>
                                    <th>ID</th>
                                    <th>Analysis Time</th>
                                    <th>Package Volume</th>
                                    <th>Updated</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Data will be here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem;">
                        <div class="text-sm text-tertiary">
                            Showing
                            <span id="tableStart">1</span>-<span id="tableEnd">0</span>
                            of <span id="tableTotal">0</span>

                            <span style="margin-left: 1rem;" id="currentPageDisplay">
                                (Page <span id="currentPage">1</span>
                                of
                                <span id="totalPages">0</span>)
                            </span>
                        </div>

                        <div style="display: flex; gap: 0.5rem;">
                            <button id="tablePrev" class="btn btn-secondary" onclick="changeTablePage(-1)" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button id="tableNext" class="btn btn-secondary" onclick="changeTablePage(1)" disabled>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer style="background: var(--bg-secondary); border-top: 1px solid var(--border-color); padding: 1.5rem 0;">
        <div class="container">
            <div class="text-center text-tertiary text-sm">
                <p>Analytics Platform v1.0.0</p>
                <p class="mt-1">¬© 2024 All rights reserved</p>
            </div>
        </div>
    </footer>

    <!-- Static JavaScript for GitHub Pages -->
    <script>
        let historyData = [];
        let filteredHistory = [];
        let chartInstance = null;
        let currentTablePage = 1;
        const tableItemsPerPage = 10;
        let pointLabels = [];
        let selectedRecords = new Set();

        // Demo data for GitHub Pages
        const demoHistoryData = [
            {
                id: 1,
                analysis_time: "2024-03-01 09:15:00",
                total_package_volume: 1245,
                created_at: "2024-03-01 09:20:00",
                updated_at: "2024-03-01 09:20:00"
            },
            {
                id: 2,
                analysis_time: "2024-03-02 10:30:00",
                total_package_volume: 1876,
                created_at: "2024-03-02 10:35:00",
                updated_at: "2024-03-02 10:35:00"
            },
            {
                id: 3,
                analysis_time: "2024-03-03 14:45:00",
                total_package_volume: 2134,
                created_at: "2024-03-03 14:50:00",
                updated_at: "2024-03-03 14:50:00"
            },
            {
                id: 4,
                analysis_time: "2024-03-04 16:20:00",
                total_package_volume: 1567,
                created_at: "2024-03-04 16:25:00",
                updated_at: "2024-03-04 16:25:00"
            },
            {
                id: 5,
                analysis_time: "2024-03-05 11:10:00",
                total_package_volume: 1987,
                created_at: "2024-03-05 11:15:00",
                updated_at: "2024-03-05 11:15:00"
            },
            {
                id: 6,
                analysis_time: "2024-03-06 13:40:00",
                total_package_volume: 2345,
                created_at: "2024-03-06 13:45:00",
                updated_at: "2024-03-06 13:45:00"
            },
            {
                id: 7,
                analysis_time: "2024-03-07 15:55:00",
                total_package_volume: 1765,
                created_at: "2024-03-07 16:00:00",
                updated_at: "2024-03-07 16:00:00"
            },
            {
                id: 8,
                analysis_time: "2024-03-08 09:30:00",
                total_package_volume: 1890,
                created_at: "2024-03-08 09:35:00",
                updated_at: "2024-03-08 09:35:00"
            },
            {
                id: 9,
                analysis_time: "2024-03-09 12:25:00",
                total_package_volume: 2176,
                created_at: "2024-03-09 12:30:00",
                updated_at: "2024-03-09 12:30:00"
            },
            {
                id: 10,
                analysis_time: "2024-03-10 17:15:00",
                total_package_volume: 1543,
                created_at: "2024-03-10 17:20:00",
                updated_at: "2024-03-10 17:20:00"
            }
        ];

        const demoChartData = {
            labels: ["Mar 1", "Mar 2", "Mar 3", "Mar 4", "Mar 5", "Mar 6", "Mar 7", "Mar 8", "Mar 9", "Mar 10"],
            data: [1245, 1876, 2134, 1567, 1987, 2345, 1765, 1890, 2176, 1543]
        };

        function showDemoNotification() {
            showNotification('Demo Mode', 'This is a static demo for GitHub Pages. All data is simulated.', 'info');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            setTimeout(checkHistoryIntegrity, 2000);

            // Setup controls
            document.getElementById('chartRange').addEventListener('change', loadHistory);
            document.getElementById('tableSort').addEventListener('change', loadHistory);

            // Add create button
            addCreateButton();
        });

        function addCreateButton() {
            const tableControls = document.querySelector('.table-controls');
            if (tableControls) {
                const createButton = document.createElement('button');
                createButton.className = 'btn btn-primary';
                createButton.innerHTML = '<i class="fas fa-plus mr-2"></i>Add New';
                createButton.onclick = openAddModal;

                tableControls.appendChild(createButton);
            }
        }

        function updateHistoryTable(data) {
            const tbody = document.getElementById('historyTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-tertiary">
                            <i class="fas fa-inbox mr-2"></i>
                            No data
                        </td>
                    </tr>
                `;
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td class="text-center">${item.id || ''}</td>
                    <td>
                        <div>${item.analysis_time || ''}</div>
                        <button class="btn btn-xs btn-link p-0 text-primary"
                                onclick="updateAnalysisTime(${item.id}, '${(item.analysis_time || '').replace(/'/g, "\\'")}')">
                            <i class="fas fa-edit mr-1"></i>Edit Time
                        </button>
                    </td>
                    <td class="text-center font-bold">${item.total_package_volume || 0}</td>
                    <td><small>${formatDate(item.created_at) || item.created_at || ''}</small></td>
                    <td>
                        <button class="btn btn-sm btn-danger"
                                onclick="deleteAnalysis(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function createHistoryChart(chartData) {
            const chartCanvas = document.getElementById('historyChart');
            if (!chartCanvas) {
                console.error('Chart canvas not found');
                return;
            }

            const ctx = chartCanvas.getContext('2d');

            if (window.historyChart instanceof Chart) {
                window.historyChart.destroy();
            }

            window.historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels || [],
                    datasets: [{
                        label: 'Package Volume',
                        data: chartData.data || [],
                        borderColor: 'rgba(79, 70, 229, 1)',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: 'var(--text-primary)',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'var(--bg-card)',
                            titleColor: 'var(--text-primary)',
                            bodyColor: 'var(--text-secondary)',
                            borderColor: 'var(--border-color)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: 'var(--text-secondary)',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: 'var(--text-secondary)',
                                precision: 0
                            },
                            title: {
                                display: true,
                                text: 'Packages',
                                color: 'var(--text-secondary)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'nearest'
                    }
                }
            });

            console.log('Chart created successfully');
        }

        function updateHistoryChart(chartData) {
            console.log('Updating chart with:', chartData);

            if (!chartData || !chartData.labels || !chartData.data ||
                chartData.labels.length === 0 || chartData.data.length === 0) {
                console.log('No valid chart data');
                return;
            }

            const ctx = document.getElementById('historyChart').getContext('2d');

            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Package Volume',
                        data: chartData.data,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Packages'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateHistoryCount(count) {
            const countElement = document.getElementById('historyCount');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        async function loadHistory() {
            try {
                showDemoNotification();
                
                selectedRecords.clear();
                updateBulkDeleteButton();

                showLoading();

                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 800));

                // Use demo data
                historyData = demoHistoryData;
                const chartData = demoChartData;

                // Update statistics
                updateStats(historyData);

                // Update table
                renderHistoryTable(historyData);

                // Update chart
                updateHistoryChart(chartData);

                // Show table
                if (historyData.length > 0) {
                    showTable();
                    updateTablePagination();
                } else {
                    showEmptyState();
                }

            } catch (error) {
                console.error('Error loading history:', error);
                showNotification('Error', `Failed to load history: ${error.message}`, 'error');
                showEmptyState();
            }
        }

        function clearSelection() {
            selectedRecords.clear();

            document.querySelectorAll('.record-checkbox').forEach(cb => {
                cb.checked = false;
            });

            updateSelectAllCheckbox();
            updateBulkDeleteButton();
        }

        function createChartWithPointLabels(chartData) {
            const ctx = document.getElementById('historyChart').getContext('2d');

            if (chartInstance) {
                chartInstance.destroy();
                pointLabels.forEach(label => label.remove());
                pointLabels = [];
            }

            const chartLabel = 'Package Volume';
            const timeLabel = 'Time';
            const packagesLabel = 'Packages';

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels || [],
                    datasets: [{
                        label: chartLabel,
                        data: chartData.data || [],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 6,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8,
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#cbd5e1',
                                font: { size: 14 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#cbd5e1',
                            bodyColor: '#cbd5e1',
                            borderColor: '#8b5cf6',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                maxRotation: 45,
                                minRotation: 45,
                                padding: 8
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                padding: 8,
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: packagesLabel,
                                color: '#94a3b8'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    elements: {
                        line: {
                            tension: 0.4
                        },
                        point: {
                            hoverRadius: 8,
                            hoverBorderWidth: 3
                        }
                    }
                },
                plugins: [{
                    id: 'pointLabels',
                    afterDatasetsDraw: function(chart, args, options) {
                        const { ctx, chartArea: { top, bottom, left, right, width, height } } = chart;

                        pointLabels.forEach(label => label.remove());
                        pointLabels = [];

                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            const meta = chart.getDatasetMeta(datasetIndex);

                            meta.data.forEach((point, index) => {
                                const value = dataset.data[index];
                                if (value === null || value === undefined) return;

                                const x = point.x;
                                const y = point.y - 25;

                                const label = document.createElement('div');
                                label.className = 'chart-point-label';
                                label.style.position = 'absolute';
                                label.style.left = `${x + left}px`;
                                label.style.top = `${y + top}px`;
                                label.style.transform = 'translateX(-50%)';
                                label.textContent = value.toLocaleString();

                                document.querySelector('.chart-container').appendChild(label);
                                pointLabels.push(label);
                            });
                        });
                    }
                }]
            });

            window.addEventListener('resize', function() {
                setTimeout(() => {
                    if (chartInstance) {
                        chartInstance.update();
                    }
                }, 100);
            });
        }

        function updateChart(chartData) {
            createChartWithPointLabels(chartData);
        }

        function updateStats() {
            if (historyData.length === 0) {
                document.getElementById('totalAnalyses').textContent = '0';
                document.getElementById('avgPackages').textContent = '0';
                document.getElementById('lastAnalysis').textContent = '-';
                document.getElementById('trend').textContent = '-';
                return;
            }

            document.getElementById('totalAnalyses').textContent = historyData.length;

            const totalPackages = historyData.reduce((sum, item) => sum + (item.total_package_volume || 0), 0);
            const avgPackages = Math.round(totalPackages / historyData.length);
            document.getElementById('avgPackages').textContent = avgPackages.toLocaleString();

            const lastAnalysis = historyData[0];
            document.getElementById('lastAnalysis').textContent = formatDateShort(lastAnalysis.analysis_time);

            if (historyData.length >= 2) {
                const recentAvg = historyData.slice(0, 3).reduce((sum, item) => sum + (item.total_package_volume || 0), 0) / 3;
                const olderAvg = historyData.slice(-3).reduce((sum, item) => sum + (item.total_package_volume || 0), 0) / 3;
                const trend = ((recentAvg - olderAvg) / olderAvg * 100).toFixed(1);
                document.getElementById('trend').textContent = `${trend > 0 ? '+' : ''}${trend}%`;
                document.getElementById('trend').className = trend > 0 ? 'stat-value trend-up' : 'stat-value trend-down';
            }
        }

        function renderHistoryTable(historyData) {
            const tbody = document.getElementById('historyTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (!historyData || historyData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-tertiary">
                            <i class="fas fa-inbox mr-2"></i>
                            No data
                        </td>
                    </tr>
                `;
                updateBulkDeleteButton();
                return;
            }

            const editTimeText = 'Edit Time';
            const editVolumeText = 'Edit';
            const deleteText = 'Delete';

            historyData.forEach(item => {
                const row = document.createElement('tr');
                const recordId = item.id;
                const isSelected = selectedRecords.has(recordId);

                const analysisTime = item.analysis_time || '';
                const createdTime = formatDateTime(item.created_at) || item.created_at || '';
                const updatedTime = formatDateTime(item.updated_at) || item.updated_at || createdTime;

                row.innerHTML = `
                    <td class="text-center">
                        <input type="checkbox"
                               class="record-checkbox"
                               data-id="${recordId}"
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleRecordSelection(${recordId}, this)">
                    </td>
                    <td class="text-center font-mono text-sm">
                        ${item.id || ''}
                    </td>
                    <td>
                        <div class="font-medium">${analysisTime}</div>
                        <button class="btn btn-xs btn-outline-primary mt-1"
                                onclick="updateAnalysisTime(${recordId}, '${analysisTime.replace(/'/g, "\\'")}')"
                                title="${editTimeText}">
                            <i class="fas fa-edit mr-1"></i>${editTimeText}
                        </button>
                    </td>
                    <td class="text-center">
                        <div class="font-bold text-primary">${item.total_package_volume || 0}</div>
                        <button class="btn btn-xs btn-outline-secondary mt-1"
                                onclick="updatePackageVolume(${recordId}, ${item.total_package_volume || 0})"
                                title="${editVolumeText}">
                            <i class="fas fa-edit mr-1"></i>${editVolumeText}
                        </button>
                    </td>
                    <td>
                        <small class="text-tertiary">${updatedTime}</small>
                    </td>
                    <td>
                        <small class="text-tertiary">${createdTime}</small>
                    </td>
                    <td>
                        <div class="flex gap-1">
                            <button class="btn btn-sm btn-danger"
                                    onclick="deleteAnalysis(${recordId})"
                                    title="${deleteText}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });

            updateBulkDeleteButton();
        }

        function toggleRecordSelection(recordId, checkbox) {
            if (checkbox.checked) {
                selectedRecords.add(recordId);
            } else {
                selectedRecords.delete(recordId);
            }
            updateBulkDeleteButton();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll(checkbox) {
            const allCheckboxes = document.querySelectorAll('.record-checkbox');
            const isChecked = checkbox.checked;

            if (isChecked) {
                allCheckboxes.forEach(cb => {
                    const recordId = parseInt(cb.dataset.id);
                    selectedRecords.add(recordId);
                    cb.checked = true;
                });
            } else {
                selectedRecords.clear();
                allCheckboxes.forEach(cb => {
                    cb.checked = false;
                });
            }

            updateBulkDeleteButton();
        }

        function updateSelectAllCheckbox() {
            const allCheckboxes = document.querySelectorAll('.record-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');

            if (allCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.disabled = true;
                return;
            }

            selectAllCheckbox.disabled = false;
            const checkedCount = document.querySelectorAll('.record-checkbox:checked').length;
            selectAllCheckbox.checked = checkedCount === allCheckboxes.length;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
        }

        function updateBulkDeleteButton() {
            const selectedCount = selectedRecords.size;
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectedCountSpan = document.getElementById('selectedCount');

            if (selectedCountSpan) {
                selectedCountSpan.textContent = selectedCount;
            }

            if (bulkDeleteBtn) {
                bulkDeleteBtn.disabled = selectedCount === 0;

                if (selectedCount === 0) {
                    bulkDeleteBtn.innerHTML = '<i class="fas fa-trash mr-2"></i> Delete';
                } else {
                    bulkDeleteBtn.innerHTML = `<i class="fas fa-trash mr-2"></i> ${selectedCount} Delete`;
                }
            }
        }

        async function bulkDeleteSelected() {
            if (selectedRecords.size === 0) {
                showNotification('Error', 'Please select records to delete', 'error');
                return;
            }

            const recordsList = Array.from(selectedRecords);
            const recordsCount = recordsList.length;

            if (!confirm(`Are you sure you want to delete ${recordsCount} record(s)?`)) {
                return;
            }

            try {
                showNotification('Info', `Deleting ${recordsCount} record(s)...`, 'info');

                let deletedCount = 0;
                let failedCount = 0;

                for (const recordId of recordsList) {
                    try {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        deletedCount++;
                    } catch (error) {
                        console.error(`Error deleting record ${recordId}:`, error);
                        failedCount++;
                    }
                }

                selectedRecords.clear();

                await loadHistory();

                if (failedCount === 0) {
                    showNotification('Success', `${deletedCount} record(s) deleted successfully (Demo)`, 'success');
                } else {
                    showNotification('Warning', `${deletedCount} deleted, ${failedCount} failed`, 'warning');
                }

            } catch (error) {
                showNotification('Error', `Bulk delete failed: ${error.message}`, 'error');
            }
        }

        function openAddModal() {
            showDemoNotification();
            document.getElementById('addModal').classList.remove('hidden');

            const now = new Date();
            const year = now.getUTCFullYear();
            const month = String(now.getUTCMonth() + 1).padStart(2, '0');
            const day = String(now.getUTCDate()).padStart(2, '0');
            const hours = String(now.getUTCHours()).padStart(2, '0');
            const minutes = String(now.getUTCMinutes()).padStart(2, '0');

            document.getElementById('newAnalysisTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('newPackageVolume').value = '';
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
        }

        async function openEditModal(id) {
            showDemoNotification();
            const item = historyData.find(item => item.id === id || item.id === parseInt(id));
            if (!item) return;

            document.getElementById('editId').value = item.id;

            document.getElementById('editAnalysisTime').value = toLocalDateTime(item.analysis_time);
            document.getElementById('editPackageVolume').value = item.total_package_volume;

            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        async function viewAnalysisDetails(id) {
            try {
                showDemoNotification();
                const item = historyData.find(item => item.id === id || item.id === parseInt(id));
                if (!item) {
                    showNotification('Error', 'Item not found', 'error');
                    return;
                }

                const detailsContent = document.getElementById('detailsContent');
                detailsContent.innerHTML = `
                    <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.875rem; color: var(--text-tertiary);">Analysis ID</div>
                            <div style="font-family: monospace; font-weight: 600; color: var(--text-primary);">${item.id}</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.875rem; color: var(--text-tertiary);">Analysis Time (UTC)</div>
                            <div style="font-weight: 500; color: var(--text-primary);">${formatDateTime(item.analysis_time)}</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.875rem; color: var(--text-tertiary);">Package Volume</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--primary);">${item.total_package_volume.toLocaleString()}</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.875rem; color: var(--text-tertiary);">Created At (UTC)</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">${item.created_at ? formatDateTime(item.created_at) : 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-tertiary);">Local Time</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                ${new Date(item.analysis_time).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('detailsModal').classList.remove('hidden');
            } catch (error) {
                showNotification('Error', error.message, 'error');
            }
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
        }

        async function createAnalysis() {
            showDemoNotification();
            const analysisTime = document.getElementById('newAnalysisTime').value;
            const packageVolume = document.getElementById('newPackageVolume').value;

            if (!analysisTime || !packageVolume) {
                showNotification('Error', 'Please fill all fields', 'error');
                return;
            }

            try {
                const localDate = new Date(analysisTime);
                const utcDate = new Date(localDate.getTime() - (localDate.getTimezoneOffset() * 60000));
                const utcDateTime = utcDate.toISOString().slice(0, 19).replace('T', ' ');

                await new Promise(resolve => setTimeout(resolve, 1000));

                showNotification('Success', 'Analysis created successfully (Demo Mode)', 'success');
                closeAddModal();
                
                await loadHistory();
            } catch (error) {
                showNotification('Error', error.message, 'error');
            }
        }

        async function updateAnalysisTime(recordId, currentTime) {
            showDemoNotification();
            const newTime = prompt('Enter new analysis time (YYYY-MM-DD HH:MM:SS):', currentTime);

            if (!newTime || newTime === currentTime) return;

            const timeRegex = /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/;
            if (!timeRegex.test(newTime)) {
                showNotification('Error', 'Invalid time format. Use YYYY-MM-DD HH:MM:SS', 'error');
                return;
            }

            try {
                await new Promise(resolve => setTimeout(resolve, 800));

                showNotification('Success', 'Analysis time updated (Demo Mode)', 'success');
                loadHistory();
            } catch (error) {
                showNotification('Error', error.message, 'error');
            }
        }

        async function updatePackageVolume(recordId, currentVolume) {
            showDemoNotification();
            const newVolume = prompt('Enter new package volume:', currentVolume);

            if (!newVolume || parseInt(newVolume) === currentVolume) return;

            if (isNaN(newVolume) || parseInt(newVolume) <= 0) {
                showNotification('Error', 'Please enter a valid positive number', 'error');
                return;
            }

            const item = historyData.find(item => item.id === recordId);
            if (!item) {
                showNotification('Error', 'Record not found', 'error');
                return;
            }

            try {
                await new Promise(resolve => setTimeout(resolve, 800));

                showNotification('Success', 'Package volume updated (Demo Mode)', 'success');
                loadHistory();
            } catch (error) {
                showNotification('Error', error.message, 'error');
            }
        }

        async function deleteAnalysis(analysisId) {
            showDemoNotification();
            if (!confirm('Are you sure you want to delete this record?')) {
                return;
            }

            try {
                await new Promise(resolve => setTimeout(resolve, 800));

                showNotification('Success', 'Record deleted (Demo Mode)', 'success');
                loadHistory();
            } catch (error) {
                showNotification('Error', error.message, 'error');
            }
        }

        function filterHistoryTable() {
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();

            if (searchTerm) {
                filteredHistory = historyData.filter(item =>
                    item.analysis_time.toLowerCase().includes(searchTerm) ||
                    item.total_package_volume.toString().includes(searchTerm) ||
                    (item.id && item.id.toString().includes(searchTerm))
                );
            } else {
                filteredHistory = [...historyData];
            }

            currentTablePage = 1;
            updateTablePagination();
            renderHistoryTable();
        }

        function sortHistory() {
            const sortBy = document.getElementById('tableSort').value;

            if (sortBy === 'newest') {
                historyData.sort((a, b) => new Date(b.analysis_time) - new Date(a.analysis_time));
            } else if (sortBy === 'oldest') {
                historyData.sort((a, b) => new Date(a.analysis_time) - new Date(b.analysis_time));
            }
        }

        function updateTablePagination() {
            const totalItems = filteredHistory.length || historyData.length || 0;
            const totalPages = Math.ceil(totalItems / tableItemsPerPage);
            const startItem = (currentTablePage - 1) * tableItemsPerPage + 1;
            const endItem = Math.min(currentTablePage * tableItemsPerPage, totalItems);

            document.getElementById('tableTotal').textContent = totalItems;
            document.getElementById('tableStart').textContent = totalItems > 0 ? startItem : 0;
            document.getElementById('tableEnd').textContent = totalItems > 0 ? endItem : 0;

            document.getElementById('currentPage').textContent = currentTablePage;
            document.getElementById('totalPages').textContent = totalPages;

            document.getElementById('tablePrev').disabled = currentTablePage === 1;
            document.getElementById('tableNext').disabled = currentTablePage === totalPages || totalPages === 0;
        }

        function updateCurrentPageDisplay(currentPage, totalPages) {
            const pageDisplay = document.getElementById('currentPageDisplay');
            if (pageDisplay) {
                pageDisplay.textContent = `Page ${currentPage} of ${totalPages}`;
            }
        }

        function changeTablePage(direction) {
            const totalItems = filteredHistory.length || historyData.length || 0;
            const totalPages = Math.ceil(totalItems / tableItemsPerPage);
            const newPage = currentTablePage + direction;

            if (newPage >= 1 && newPage <= totalPages) {
                currentTablePage = newPage;
                renderHistoryTable(getCurrentPageData());
                updateTablePagination();
            }
        }

        function getCurrentPageData() {
            const data = filteredHistory.length > 0 ? filteredHistory : historyData;
            const startIndex = (currentTablePage - 1) * tableItemsPerPage;
            const endIndex = startIndex + tableItemsPerPage;
            return data.slice(startIndex, endIndex);
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';

            try {
                const date = new Date(dateString);

                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'UTC'
                };

                return date.toLocaleDateString('en-US', options) + ' ' +
                       date.toLocaleTimeString('en-US', {
                           hour: '2-digit',
                           minute: '2-digit',
                           timeZone: 'UTC'
                       });
            } catch (e) {
                return dateString;
            }
        }

        function toLocalDateTime(dateString) {
            if (!dateString) return '';

            try {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');

                return `${year}-${month}-${day}T${hours}:${minutes}`;
            } catch (e) {
                return dateString;
            }
        }

        function formatDateShort(dateString) {
            if (!dateString) return '';

            try {
                const date = new Date(dateString);
                const now = new Date();

                const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return 'Yesterday';
                if (diffDays < 7) return `${diffDays} days ago`;

                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    timeZone: 'UTC'
                });
            } catch (e) {
                return dateString;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    timeZone: 'UTC'
                });
            } catch (e) {
                return dateString;
            }
        }

        async function refreshChart() {
            try {
                showNotification('Info', 'Refreshing chart...', 'info');

                await loadHistory();

                showNotification('Success', 'Chart updated successfully', 'success');
            } catch (error) {
                console.error('Error refreshing chart:', error);
                showNotification('Error', `Failed to update chart: ${error.message}`, 'error');
            }
        }

        async function checkHistoryIntegrity() {
            try {
                await new Promise(resolve => setTimeout(resolve, 500));
            } catch (error) {
                console.log('Integrity check failed:', error);
            }
        }

        async function exportSimpleHistory() {
            showDemoNotification();
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Preparing...';
                button.disabled = true;

                showNotification('Info', 'Preparing export...', 'info');

                await new Promise(resolve => setTimeout(resolve, 1500));

                const csvContent = 'Analysis Time,Package Volume\n' +
                    historyData.map(item => 
                        `${item.analysis_time},${item.total_package_volume}`
                    ).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `history_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('Success', 'Exported to CSV (Demo Mode)', 'success');

            } catch (error) {
                console.error('Export error:', error);
                showNotification('Error', `Export failed: ${error.message}`, 'error');

                try {
                    await exportAsCSV();
                } catch (csvError) {
                    console.error('CSV export also failed:', csvError);
                }

            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function exportAsCSV() {
            const rows = [];

            rows.push(['Analysis Time', 'Package Volume']);

            const tableRows = document.querySelectorAll('#historyTableBody tr');
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    const time = cells[2].textContent.trim();
                    const volume = cells[3].querySelector('.font-bold').textContent.replace(/\D/g, '');
                    rows.push([time, volume]);
                }
            });

            if (rows.length > 1) {
                const csvContent = rows.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `history_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('Info', 'Exported as CSV (Demo Mode)', 'info');
            }
        }

        function showLoading() {
            document.getElementById('loadingHistory').classList.remove('hidden');
            document.getElementById('historyTableContainer').classList.add('hidden');
            document.getElementById('emptyHistory').classList.add('hidden');
        }

        function showTable() {
            document.getElementById('loadingHistory').classList.add('hidden');
            document.getElementById('historyTableContainer').classList.remove('hidden');
            document.getElementById('emptyHistory').classList.add('hidden');
        }

        function showEmptyState() {
            document.getElementById('loadingHistory').classList.add('hidden');
            document.getElementById('historyTableContainer').classList.add('hidden');
            document.getElementById('emptyHistory').classList.remove('hidden');
        }

        function exportData(data, filename) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        function showNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                z-index: 10000;
                min-width: 300px;
                max-width: 400px;
                animation: slideInFromTop 0.3s ease;
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius);
                padding: 1rem;
                box-shadow: var(--shadow-lg);
            `;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-triangle';
            if (type === 'warning') icon = 'exclamation-circle';
            
            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                    <i class="fas fa-${icon}" style="font-size: 1.25rem; color: var(--${type === 'success' ? 'color-success' : type === 'error' ? 'color-danger' : type === 'warning' ? 'color-warning' : 'color-primary'});"></i>
                    <div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">${title}</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--text-tertiary); cursor: pointer; padding: 0; margin-left: auto;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        document.addEventListener('click', function(event) {
            const addModal = document.getElementById('addModal');
            const editModal = document.getElementById('editModal');
            const detailsModal = document.getElementById('detailsModal');

            if (!addModal.classList.contains('hidden') && event.target === addModal) {
                closeAddModal();
            }
            if (!editModal.classList.contains('hidden') && event.target === editModal) {
                closeEditModal();
            }
            if (!detailsModal.classList.contains('hidden') && event.target === detailsModal) {
                closeDetailsModal();
            }
        });
    </script>
    <!-- Modal for adding new record -->
    <div id="addModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Add New Analysis (Demo)</h3>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Analysis Time</label>
                    <input type="datetime-local" id="newAnalysisTime" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Package Volume</label>
                    <input type="number" id="newPackageVolume" class="form-control" min="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createAnalysis()">Add</button>
            </div>
        </div>
    </div>

    <!-- Modal for editing -->
    <div id="editModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Edit Analysis (Demo)</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label class="form-label">Analysis Time</label>
                    <input type="datetime-local" id="editAnalysisTime" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Package Volume</label>
                    <input type="number" id="editPackageVolume" class="form-control" min="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="updateAnalysis()">Save</button>
            </div>
        </div>
    </div>

    <!-- Modal for details -->
    <div id="detailsModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Analysis Details (Demo)</h3>
                <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="detailsContent"></div>
            </div>
        </div>
    </div>

</body>
</html>